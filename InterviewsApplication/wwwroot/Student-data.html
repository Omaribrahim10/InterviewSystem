<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Data</title>
    
    
    
    


  <link rel="stylesheet" href="./assets/compiled/css/app.css">
  <link rel="stylesheet" href="./assets/compiled/css/app-dark.css">
  <link rel="stylesheet" href="./assets/compiled/css/iconly.css">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="./assets/compiled/css/style.css">
</head>

<body class="cairo-font">
    <script src="assets/static/js/initTheme.js"></script>
    <div id="app">
       
        <div id="main" class="mx-0">
            <header class="mb-3">
                <a href="#" class="burger-btn d-block d-xl-none">
                    <i class="bi bi-justify fs-3"></i>
                </a>
            </header>

            <div class="page-heading text-center">
                <h3 class="mt-2">بيانات الطالب / إستبيان</h3>
            </div>
            <div class="page-content">
                <section class="row">
                    <div class="col-12 col-lg-12">


                        <div class="row stud-data-row" style="direction: rtl;">
                            <div class="col-12 col-xl-6">
                                <div class="card">
                                    <div class="card-header">
                                        <div class="alert alert-primary">
                                            <h4 class="alert-heading"><i class="bi bi-file-earmark-person m-2"></i>بيانات الطالب  </h4>
                                            <p>بيانات الطالب المتقدم للمقابله</p>
                                        </div>

                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table table-hover table-lg student-data">
                                                <tbody>
                                                    <tr>
                                                        <td class="col-4">
                                                            <div class="d-flex align-items-center">
                                                                <p class="font-bold ms-3 mb-0">الرقم القومى</p>
                                                            </div>
                                                        </td>
                                                        <td class="col-auto">
                                                            <p id="national_id" class="mb-0"></p>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="col-4">
                                                            <div class="d-flex align-items-center">
                                                                <p class="font-bold ms-3 mb-0">الرقم الجامعى</p>
                                                            </div>
                                                        </td>
                                                        <td class="col-auto">
                                                            <p id="university_id" class="mb-0"></p>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="col-4">
                                                            <div class="d-flex align-items-center">
                                                                <p class="font-bold ms-3 mb-0">الإسم كاملاَ</p>
                                                            </div>
                                                        </td>
                                                        <td class="col-auto">
                                                            <p id="full_name" class="mb-0"></p>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="col-4">
                                                            <div class="d-flex align-items-center">
                                                                <p class="font-bold ms-3 mb-0">تاريخ الميلاد</p>
                                                            </div>
                                                        </td>
                                                        <td class="col-auto">
                                                            <p id="birth_date" class="mb-0"></p>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="col-4">
                                                            <div class="d-flex align-items-center">
                                                                <p class="font-bold ms-3 mb-0">الجنسية</p>
                                                            </div>
                                                        </td>
                                                        <td class="col-auto">
                                                            <p id="nationality" class="mb-0"></p>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="col-4">
                                                            <div class="d-flex align-items-center">
                                                                <p class="font-bold ms-3 mb-0">عنوان السكن</p>
                                                            </div>
                                                        </td>
                                                        <td class="col-auto">
                                                            <p id="address" class="mb-0"></p>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="col-4">
                                                            <div class="d-flex align-items-center">
                                                                <p class="font-bold ms-3 mb-0">التليفون الأرضى</p>
                                                            </div>
                                                        </td>
                                                        <td class="col-auto">
                                                            <p id="landline" class="mb-0"></p>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="col-4">
                                                            <div class="d-flex align-items-center">
                                                                <p class="font-bold ms-3 mb-0">المؤهل الدراسى/<br> نوع الشهادة</p>
                                                            </div>
                                                        </td>
                                                        <td class="col-auto">
                                                            <p id="degree" class="mb-0"></p>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="col-4">
                                                            <div class="d-flex align-items-center">
                                                                <p class="font-bold ms-3 mb-0">مجموع الدرجات</p>
                                                            </div>
                                                        </td>
                                                        <td class="col-auto">
                                                            <p id="total_marks" class="mb-0"></p>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>

                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 col-xl-6">
                                <div class="card">

                                    <div class="card-body">
                                        <div class="table-responsive pt-5">
                                            <table class="table table-hover table-lg student-data mt-2">

                                                <tbody>
                                                    <tr>
                                                        <td class="col-4">
                                                            <div class="d-flex align-items-center">
                                                                <p class="font-bold ms-3 mb-0"> البريد الالكترونى </p>
                                                            </div>
                                                        </td>
                                                        <td class="col-auto">
                                                            <p class="mb-0" id="email"></p>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="col-4">
                                                            <div class="d-flex align-items-center">
                                                                <p class="font-bold ms-3 mb-0"> محل الميلاد </p>
                                                            </div>
                                                        </td>
                                                        <td class="col-auto">
                                                            <p class="mb-0" id="birth_country"></p>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="col-4">
                                                            <div class="d-flex align-items-center">
                                                                <p class="font-bold ms-3 mb-0"> الديانة </p>
                                                            </div>
                                                        </td>
                                                        <td class="col-auto">
                                                            <p class="mb-0" id="religion"></p>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="col-4">
                                                            <div class="d-flex align-items-center">
                                                                <p class="font-bold ms-3 mb-0"> الكلية المتقدم لها </p>
                                                            </div>
                                                        </td>
                                                        <td class="col-auto">
                                                            <p class="mb-0" id="college"></p>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="col-4">
                                                            <div class="d-flex align-items-center">
                                                                <p class="font-bold ms-3 mb-0"> الموبايل </p>
                                                            </div>
                                                        </td>
                                                        <td class="col-auto">
                                                            <p class="mb-0" id="phone"></p>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="col-4">
                                                            <div class="d-flex align-items-center">
                                                                <p class="font-bold ms-3 mb-0"> اسم المدرسة </p>
                                                            </div>
                                                        </td>
                                                        <td class="col-auto">
                                                            <p class="mb-0" id="school"></p>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="col-4">
                                                            <div class="d-flex align-items-center">
                                                                <p class="font-bold ms-3 mb-0"> سنة الحصول </p>
                                                            </div>
                                                        </td>
                                                        <td class="col-auto">
                                                            <p class="mb-0" id="date_of_degree"></p>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="col-4">
                                                            <div class="d-flex align-items-center">
                                                                <p class="font-bold ms-3 mb-0"> النسبة المئوية </p>
                                                            </div>
                                                        </td>
                                                        <td class="col-auto">
                                                            <p class="mb-0" id="percentage"></p>
                                                        </td>
                                                    </tr>
                                                </tbody>

                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 col-xl-12">
                                <div class="card">
                                    <div class="card-header">
                                        <div class="alert alert-primary">
                                            <h4 class="alert-heading"><i class="bi bi-file-earmark-person-fill"></i>    بيانات ولى الأمر  </h4>
                                            <p>بيانات ولى أمر الطالب المتقدم للمقابله</p>
                                        </div>

                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table table-hover table-lg student-data mt-2">

                                                <tbody>
                                                    <tr>
                                                        <td class="col-4">
                                                            <div class="d-flex align-items-center">
                                                                <p class="font-bold ms-3 mb-0"> الإسم كاملاَ </p>
                                                            </div>
                                                        </td>
                                                        <td class="col-auto">
                                                            <p class="mb-0" id="parent_name"></p>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="col-4">
                                                            <div class="d-flex align-items-center">
                                                                <p class="font-bold ms-3 mb-0"> نوع القرابة </p>
                                                            </div>
                                                        </td>
                                                        <td class="col-auto">
                                                            <p class="mb-0" id="relationship"></p>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="col-4">
                                                            <div class="d-flex align-items-center">
                                                                <p class="font-bold ms-3 mb-0"> تليفون العمل </p>
                                                            </div>
                                                        </td>
                                                        <td class="col-auto">
                                                            <p class="mb-0" id="work_phone_number"></p>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="col-4">
                                                            <div class="d-flex align-items-center">
                                                                <p class="font-bold ms-3 mb-0"> المهنه </p>
                                                            </div>
                                                        </td>
                                                        <td class="col-auto">
                                                            <p class="mb-0" id="proffesion"></p>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="col-4">
                                                            <div class="d-flex align-items-center">
                                                                <p class="font-bold ms-3 mb-0"> الموبايل </p>
                                                            </div>
                                                        </td>
                                                        <td class="col-auto">
                                                            <p class="mb-0" id="parent_phone_number"></p>
                                                        </td>
                                                    </tr>
                                                </tbody>

                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>

                </section>
                <div class="page-heading">
                    <div class="page-title text-center">
                        <div class="row">
                            <div class="col-12 col-md-12 order-md-1 order-last">
                                <h3>إستبيان</h3>
                                <p class="text-subtitle text-muted">
                                    ضرورة ملء كل البيانات
                                </p>
                            </div>

                        </div>
                    </div>

                    <section id="multiple-column-form" style="direction: rtl;">
                        <div class="row match-height">
                            <div class="col-12">
                                <div class="card">

                                    <div class="card-content">
                                        <div class="card-body">
                                            <form class="form poll-form" data-parsley-validate>
                                                <div class="row">
                                                    <div class="col-md-12 col-12">
                                                        <div class="form-group mandatory">
                                                            <label for="first-name-column" class="form-label alert alert-primary">كيف تعرفت على الجامعه ؟</label>
                                                            <ul class="list-unstyled mb-0 px-5 py-3">
                                                                <li class="d-inline-block me-2 mb-3">
                                                                    <div class="form-check" style="direction: ltr;">
                                                                        <div class="custom-control custom-checkbox d-flex w-100 justify-content-end">
                                                                            <input style="order: 2;" type="checkbox"
                                                                                   class="form-check-input form-check-primary form-check-glow" checked
                                                                                   name="customCheck" id="checkboxGlow1">
                                                                            <label style="order: 1;" class="form-check-label" for="checkboxGlow1">الأصدقاء والأقارب</label>
                                                                        </div>
                                                                    </div>
                                                                </li>

                                                                <li class="d-inline-block me-2 mb-3">
                                                                    <div class="form-check" style="direction: ltr;">
                                                                        <div class="custom-control custom-checkbox d-flex w-100 justify-content-end">
                                                                            <input style="order: 2;" type="checkbox"
                                                                                   class="form-check-input form-check-primary form-check-glow"
                                                                                   name="customCheck" id="checkboxGlow2">
                                                                            <label style="order: 1;" class="form-check-label" for="checkboxGlow2"> لافتات الطريق</label>
                                                                        </div>
                                                                    </div>
                                                                </li>

                                                                <li class="d-inline-block me-2 mb-3">
                                                                    <div class="form-check" style="direction: ltr;">
                                                                        <div class="custom-control custom-checkbox d-flex w-100 justify-content-end">
                                                                            <input style="order: 2;" type="checkbox"
                                                                                   class="form-check-input form-check-primary form-check-glow"
                                                                                   name="customCheck" id="checkboxGlow3">
                                                                            <label style="order: 1;" class="form-check-label" for="checkboxGlow3">Facebook </label>
                                                                        </div>
                                                                    </div>
                                                                </li>
                                                                <li class="d-inline-block me-2 mb-3">
                                                                    <div class="form-check" style="direction: ltr;">
                                                                        <div class="custom-control custom-checkbox d-flex w-100 justify-content-end">
                                                                            <input style="order: 2;" type="checkbox"
                                                                                   class="form-check-input form-check-primary form-check-glow"
                                                                                   name="customCheck" id="checkboxGlow4">
                                                                            <label style="order: 1;" class="form-check-label" for="checkboxGlow4">إعلانات نادى سبورتنج الرياضى </label>
                                                                        </div>
                                                                    </div>
                                                                </li>
                                                                <br>
                                                                <li class="d-inline-block me-2 mb-3">
                                                                    <div class="form-check" style="direction: ltr;">
                                                                        <div class="custom-control custom-checkbox d-flex w-100 justify-content-end">
                                                                            <input style="order: 2;" type="checkbox"
                                                                                   class="form-check-input form-check-primary form-check-glow"
                                                                                   name="customCheck" id="checkboxGlow5">
                                                                            <label style="order: 1;" class="form-check-label" for="checkboxGlow5"> توزيع لمطبوعات الجامعه (فلاير/ بروشور)</label>
                                                                        </div>
                                                                    </div>
                                                                </li>
                                                                <li class="d-inline-block me-2 mb-3">
                                                                    <div class="form-check" style="direction: ltr;">
                                                                        <div class="custom-control custom-checkbox d-flex w-100 justify-content-end">
                                                                            <input style="order: 2;" type="checkbox"
                                                                                   class="form-check-input form-check-primary form-check-glow"
                                                                                   name="customCheck" id="checkboxGlow6">
                                                                            <label style="order: 1;" class="form-check-label" for="checkboxGlow6">الموقع الإلكترونى للجامعه </label>
                                                                        </div>
                                                                    </div>
                                                                </li>
                                                                <li class="d-inline-block me-2 mb-3">
                                                                    <div class="form-check" style="direction: ltr;">
                                                                        <div class="custom-control custom-checkbox d-flex w-100 justify-content-end">
                                                                            <input style="order: 2;" type="checkbox"
                                                                                   class="form-check-input form-check-primary form-check-glow"
                                                                                   name="customCheck" id="checkboxGlow7">
                                                                            <label style="order: 1;" class="form-check-label" for="checkboxGlow7">الزيارات المدرسيه للحرم الجامعى </label>
                                                                        </div>
                                                                    </div>
                                                                </li>


                                                            </ul>
                                                        </div>
                                                    </div>

                                                    <div class="col-md-12 col-12">
                                                        <div class="form-group mb-3">
                                                            <label for="other_sources" class="form-label">مصادر اخرى</label>
                                                            <textarea class="form-control" id="other_sources" rows="3"></textarea>
                                                        </div>
                                                    </div>

                                                    <div class="col-md-6 col-12">
                                                        <div class="form-group mb-3 mandatory">
                                                            <label for="Activities" class="form-label">ممارسة أنشطة رياضية او هوايات </label>
                                                            <textarea class="form-control" id="Activities" rows="3"></textarea>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6 col-12">
                                                        <div class="form-group mb-3 mandatory">
                                                            <label for="Awards" class="form-label">تحقيق بطولات محليه او دوليه </label>
                                                            <textarea class="form-control" id="Awards" rows="3"></textarea>
                                                        </div>
                                                    </div>

                                                    <div class="col-md-6 col-6">
                                                        <div class="form-group mandatory">
                                                            <label for="first-name-column" class="form-label">برجاء تحميل صورة شخصيه حديثة</label>
                                                            <input type="file"
                                                                   class="form-control"
                                                                   id="ImageAttach"
                                                                   name="profile_photo"
                                                                   accept="image/*">
                                                        </div>
                                                    </div>


                                                </div>

                                                <div class="row">
                                                    <div class="col-12 d-flex justify-content-end">
                                                        <button type="submit" id="submit-btn" class="btn btn-primary me-1 mb-1">
                                                            ارسال
                                                        </button>
                                                        <button type="reset"
                                                                class="btn btn-light-secondary me-1 mb-1">
                                                            مسح
                                                        </button>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </div>

        </div>
    </div>
    <script src="assets/static/js/DefaultSettingsBlock.js"></script>

    <script src="assets/static/js/components/dark.js"></script>
    <script src="assets/extensions/perfect-scrollbar/perfect-scrollbar.min.js"></script>


    <script src="assets/compiled/js/app.js"></script>



    <script src="assets/extensions/apexcharts/apexcharts.min.js"></script>
    <script src="assets/static/js/pages/dashboard.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            const universityId = sessionStorage.getItem("university_id");

            if (!universityId) {
                window.location.href = "student-login.html";
                return;
            }

            try {
                const response = await fetch("https://localhost:7286/api/StudentsView/me", {
                    method: "GET",
                    credentials: "include"
                });
                if (!response.ok) return;

                const data = await response.json();

                document.getElementById("national_id").textContent = data.nationalID ?? "";
                document.getElementById("university_id").textContent = data.universityID ?? "";
                document.getElementById("full_name").textContent = data.fullName ?? "";
                document.getElementById("birth_date").textContent = formatDate(data.birthDate);
                document.getElementById("nationality").textContent = data.nationality ?? "";
                document.getElementById("address").textContent = data.address ?? "";
                document.getElementById("landline").textContent = data.landline ?? "";
                document.getElementById("degree").textContent = data.degree ?? "";
                document.getElementById("total_marks").textContent = data.totalMarks ?? "";
                document.getElementById("email").textContent = data.email ?? "";
                document.getElementById("birth_country").textContent = data.birthCountry ?? "";
                document.getElementById("religion").textContent = data.religion ?? "";
                document.getElementById("college").textContent = data.college ?? "";
                document.getElementById("phone").textContent = data.phone ?? "";
                document.getElementById("school").textContent = data.school ?? "";
                document.getElementById("date_of_degree").textContent = formatDate(data.dateOfDegree);
                document.getElementById("percentage").textContent = data.percentage ? `${data.percentage}%` : "";
                document.getElementById("parent_name").textContent = data.parentName ?? "";
                document.getElementById("relationship").textContent = data.relationship ?? "";
                document.getElementById("work_phone_number").textContent = data.workPhoneNumber ?? "";
                document.getElementById("proffesion").textContent = data.proffesion ?? "";
                document.getElementById("parent_phone_number").textContent = data.parentPhoneNumber ?? "";

            } catch (err) {
                console.error("Failed to load student data:", err)
                Swal.fire({ icon: "error", title: "Unable to load your profile", text: "Please try again later or contact support.", confirmButtonText: "OK" });

            }

            function formatDate(dateStr) {
                if (!dateStr) return "";
                const d = new Date(dateStr);
                return `${d.getDate()}/${d.getMonth() + 1}/${d.getFullYear()}`;
            }
        });
    </script>

    <script>
        const checkboxes = document.querySelectorAll('input[name="customCheck"]');
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function () {
                if (this.checked) {
                    checkboxes.forEach(cb => {
                        if (cb !== this) cb.checked = false;
                    });
                }
            });
        });
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const submitBtn = document.getElementById("submit-btn");

            if (submitBtn) {
                submitBtn.addEventListener("click", async (e) => {
                    e.preventDefault();

                    try {
                        const userRes = await fetch("https://localhost:7286/api/StudentsView/me", {
                            method: "GET",
                            credentials: "include"
                        });

                        if (!userRes.ok) throw new Error("Not authenticated");

                        const user = await userRes.json();
                        const universityID = user.universityID;

                        const existingDataRes = await fetch(`https://localhost:7286/api/StudentsData/info/${universityID}`, {
                            method: "GET",
                            credentials: "include"
                        });


                        let isEditMode = false;
                        let isLocked = false;

                        if (existingDataRes.ok) {
                            const existingData = await existingDataRes.json();
                            console.log("existingData:", existingData);

                            isEditMode = true;
                            isLocked = existingData.isLocked;

                            if (isLocked) {
                                Swal.fire({
                                    icon: "error",
                                    title: "لا يمكنك تعديل بياناتك بعد المراجعة.",
                                    confirmButtonText: "حسنًا"
                                });
                                return;
                            }
                        }

                        const selectedCheckbox = document.querySelector('input[name="customCheck"]:checked');
                        const referralSource = selectedCheckbox ? selectedCheckbox.nextElementSibling.textContent.trim() : "";

                        const activities = document.getElementById("Activities").value.trim();
                        const awards = document.getElementById("Awards").value.trim();
                        const imageFile = document.getElementById("ImageAttach").files[0];

                        const formData = new FormData();
                        formData.append("UniversityID", universityID);
                        formData.append("ReferralSource", referralSource);
                        formData.append("Activities", activities);
                        formData.append("Awards", awards);
                        if (imageFile) formData.append("ImageAttach", imageFile);

                        const url = "https://localhost:7286/api/StudentsData";
                        const method = isEditMode ? "PUT" : "POST";

                        const res = await fetch(url, {
                            method,
                            credentials: "include",
                            body: formData
                        });

                        if (res.ok) {
                            Swal.fire({
                                icon: "success",
                                title: "تم حفظ البيانات بنجاح ✅",
                                showConfirmButton: false,
                                timer: 1500
                            }).then(() => {
                                window.location.href = "Student-data-print-from-img.html";
                            });
                        } else {
                            const msg = await res.text();
                            Swal.fire({
                                icon: "error",
                                title: "فشل في إرسال البيانات",
                                text: "برجاء ارسال جميع بيانات الاستبيان",
                                confirmButtonText: "حسنًا"
                            });
                        }

                    } catch (err) {
                        console.error(err);
                        Swal.fire({
                            icon: "error",
                            title: "حدث خطأ أثناء إرسال البيانات",
                            text: err.message || "يرجى المحاولة مرة أخرى لاحقًا",
                            confirmButtonText: "حسنًا"
                        });
                    }
                });
            }
        });
    </script>




</body>

</html>