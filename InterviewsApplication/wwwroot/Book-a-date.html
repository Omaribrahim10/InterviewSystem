<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book A Date</title>

    <link rel="stylesheet" href="assets/extensions/choices.js/public/assets/styles/choices.css">





    <link rel="stylesheet" href="./assets/compiled/css/app.css">
    <link rel="stylesheet" href="./assets/compiled/css/app-dark.css">
</head>

<body>
    <script src="assets/static/js/initTheme.js"></script>
    <div id="app">
        <div id="main" class="mx-0">
            <header class="mb-3">
                <a href="#" class="burger-btn d-block d-xl-none">
                    <i class="bi bi-justify fs-3"></i>
                </a>
            </header>

            <div class="page-heading">
                <div class="page-title">
                    <div class="row">
                        <div class="col-12 col-md-6 order-md-1 order-last">
                            <div class="logo d-flex">
                                
                                <div class="mt-4">
                                    <h3 class="pt-2 mb-0">Book a date</h3>
                                    <p class="text-subtitle text-muted">choose an interview date</p>
                                </div>
                            </div>

                        </div>
                        <div class="col-12 col-md-6 order-md-2 order-first">

                        </div>
                    </div>
                </div>



                <section class="input-group-select">
                    <div class="row">
                        <div class="col-12">
                            <div class="card">

                                <div class="card-content">
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-12 mb-12">
                                                <h6>please select one of these days </h6>
                                                <div class="input-group mb-3">
                                                    <label class="input-group-text" for="inputGroupSelect01">Options</label>
                                                    <select class="form-select" id="inputGroupSelect01">
                                                        <option selected>Choose...</option>
                                                    </select>
                                                </div>
                                            </div>

                                        </div>
                                        <div style="text-align: right;">
                                            <button type="submit" class="btn btn-primary me-1 mb-1">Submit</button>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>




            </div>


        </div>
    </div>
    <script src="assets/static/js/components/dark.js"></script>
    <script src="assets/extensions/perfect-scrollbar/perfect-scrollbar.min.js"></script>


    <script src="assets/compiled/js/app.js"></script>



    <script src="assets/extensions/choices.js/public/assets/scripts/choices.js"></script>
    <script src="assets/static/js/pages/form-element-select.js"></script>



</body>

</html>
<script src="assets/static/js/DefaultSettingsBlock.js"></script>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    async function loadInterviewSchedules() {
        try {
            const res = await fetch("https://localhost:7286/api/InterviewSchedule", {
                method: "GET",
                headers: {
                    "Content-Type": "application/json",
                }
            });

            if (!res.ok) throw new Error("Failed to fetch schedules");

            const schedules = await res.json();
            const select = document.getElementById("inputGroupSelect01");
            select.innerHTML = '<option selected disabled>Choose...</option>';

            schedules.forEach(schedule => {
                const dateObj = new Date(schedule.interviewDate);
                const day = dateObj.toLocaleDateString("en-US", { weekday: 'long' });
                const formattedDate = `${dateObj.getDate()}/${dateObj.getMonth() + 1}/${dateObj.getFullYear()}`;

                const option = document.createElement("option");
                option.value = schedule.scheduleID;
                option.textContent = `${day} - ${formattedDate}`;
                select.appendChild(option);
            });

        } catch (err) {
            console.error("âŒ Error loading interview schedules:", err);
            Swal.fire({ icon: 'error', title: 'Error', text: 'Could not load schedule list' });
        }
    }

    async function handleBookingSubmit(e) {
        e.preventDefault();

        const select = document.getElementById("inputGroupSelect01");
        const scheduleID = select.value;

        if (!scheduleID || scheduleID === "Choose...") {
            Swal.fire({ icon: 'warning', title: 'Warning', text: 'Please select a schedule.' });
            return;
        }

        const universityID = sessionStorage.getItem("university_id");

        const payload = {
            scheduleID: parseInt(scheduleID),
            universityID: universityID
        };
        
        try {
            const res = await fetch("https://localhost:7286/api/StudentBooking", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(payload)
            });

            if (!res.ok) {
                const errorMsg = await res.text();
                throw new Error(errorMsg);
            }

            const message = await res.text();
            Swal.fire({
                icon: 'success',
                title: 'Success',
                text: message
            }).then(() => {
                window.location.href = "../Thank-you-page-interview.html";
            });

        } catch (err) {
            console.error("âŒ Booking failed:", err);
            Swal.fire({ icon: 'error', title: 'Booking Failed', text: err.message });
        }
    }

    async function fetchScheduleDetails(scheduleID) {
        try {
            const res = await fetch(`https://localhost:7286/api/InterviewSchedule/${scheduleID}`);
            if (!res.ok) throw new Error("Schedule not found");

            const schedule = await res.json();
            console.log("ðŸ“… Full Schedule Details:", schedule);
        } catch (err) {
            console.error("âŒ Error fetching full schedule:", err);
            Swal.fire({ icon: 'error', title: 'Error', text: err.message });
        }
    }

    window.addEventListener("DOMContentLoaded", () => {
        loadInterviewSchedules();

        const submitButton = document.querySelector(".btn-primary");
        if (submitButton) {
            submitButton.addEventListener("click", handleBookingSubmit);
            submitButton.addEventListener("click", () => {
                const select = document.getElementById("inputGroupSelect01");
                const selectedValue = select.value;
                if (selectedValue && selectedValue !== "Choose...") {
                    fetchScheduleDetails(selectedValue);
                }
            });
        }
    });
</script>
