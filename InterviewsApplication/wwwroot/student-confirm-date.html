<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Booking Confirmation</title>

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="./assets/compiled/css/app.css" />
    <link rel="stylesheet" href="./assets/compiled/css/style.css" />
    <link rel="stylesheet" href="./assets/compiled/css/iconly.css" />

    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f5f5f5;
        }

        .page-heading {
            text-align: center;
            margin-top: 30px;
        }

        .student-card-container {
            width: 794px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }

        .card-header {
            background: #4e73df;
            color: white;
            padding: 1rem;
            text-align: center;
            border-radius: 10px 10px 0 0;
        }

        .card-body table {
            width: 100%;
            border-collapse: collapse;
        }

        .card-body td {
            padding: 10px;
            border: 1px solid #ccc;
        }

        .btn-container {
            text-align: center;
            margin: 20px;
        }

        .btn {
            margin: 5px;
        }

        @media print {
            .btn-container, header, footer {
                display: none !important;
            }

            @page {
                size: A4 portrait;
                margin: 0;
            }

            html, body {
                margin: 0 !important;
                padding: 0 !important;
                background: none !important;
            }
        }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
    <div class="page-heading">
        <h2>Booking Confirmed</h2>
        <p>Your reservation has been successfully recorded.</p>
    </div>

    <!--<div class="btn-container" id="btnGroup">
        <button class="btn btn-primary" id="downloadPdfBtn">📄 Download PDF</button>
    </div>-->

    <div class="student-card-container" id="pdfCard">
        <div class="card-header">
            <h3>Student Booking Details</h3>
        </div>
        <div class="card-body">
            <table>
                <tbody>
                    <tr><td><strong>Name:</strong></td><td id="name">---</td></tr>
                    <tr><td><strong>University ID:</strong></td><td id="universityID">---</td></tr>
                    <tr><td><strong>Phone:</strong></td><td id="phone">---</td></tr>
                    <tr><td><strong>National ID:</strong></td><td id="nationalID">---</td></tr>
                    <tr><td><strong>Booking Date:</strong></td><td id="bookingDate">---</td></tr>
                    <tr><td><strong>Location:</strong></td><td id="Location">---</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    <script src="assets/static/js/DefaultSettingsBlock.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const universityID = sessionStorage.getItem("university_id");

            async function populateStudentData() {
                try {
                    const response = await fetch(`https://localhost:7286/api/StudentBooking/pdf-data/${universityID}`);
                    if (!response.ok) throw new Error("Failed to fetch student data");

                    const student = await response.json();

                    document.getElementById("name").textContent = student.name;
                    document.getElementById("universityID").textContent = student.universityID;
                    document.getElementById("phone").textContent = student.phone;
                    document.getElementById("nationalID").textContent = student.nationalID;
                    document.getElementById("Location").textContent = student.location; 

                    const formattedDate = new Date(student.bookedAt).toLocaleString("en-GB", {
                        year: "numeric", month: "2-digit", day: "2-digit",
                        hour: "2-digit", minute: "2-digit", hour12: true
                    }).replace("am", "AM").replace("pm", "PM");

                    document.getElementById("bookingDate").textContent = formattedDate;
                } catch (err) {
                    console.error("❌ Error loading student data:", err);
                    alert("Error loading student data.");
                }
            }

            async function convertLogoToBase64(imgSelector) {
                return new Promise((resolve, reject) => {
                    const img = document.querySelector(imgSelector);
                    const canvas = document.createElement("canvas");
                    canvas.width = img.naturalWidth;
                    canvas.height = img.naturalHeight;
                    const ctx = canvas.getContext("2d");
                    ctx.drawImage(img, 0, 0);
                    resolve(canvas.toDataURL("image/png"));
                });
            }

            async function downloadPDF() {
                const logoImg = document.querySelector("#pdfLogo");
                const btnGroup = document.getElementById("btnGroup");

                const base64Logo = await convertLogoToBase64("#pdfLogo");
                logoImg.setAttribute("src", base64Logo);

                btnGroup.style.display = "none";

                const opt = {
                    margin: 0,
                    filename: "booking-confirmation.pdf",
                    image: { type: "jpeg", quality: 1 },
                    html2canvas: { scale: 2, useCORS: true, scrollY: 0 },
                    jsPDF: { unit: "pt", format: "a4", orientation: "portrait" },
                    pagebreak: { mode: ['avoid-all'] }
                };

                await html2pdf().set(opt).from(document.body).save();

                btnGroup.style.display = "block";
                logoImg.setAttribute("src", "./assets/static/images/logo/logo.png");
            }

            populateStudentData();
            document.getElementById("downloadPdfBtn").addEventListener("click", downloadPDF);
        });
    </script>
</body>
</html>
