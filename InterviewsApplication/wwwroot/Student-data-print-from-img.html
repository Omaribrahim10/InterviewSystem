<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8" />
    <title>Student Data</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" href="./assets/compiled/css/style.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Cairo&family=Amiri&display=swap" rel="stylesheet" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        body {
            font-family: 'Cairo', 'Amiri', Arial, sans-serif;
            font-size: 14px;
            direction: rtl;
            margin: 20px;
            unicode-bidi: embed;
        }

        .a4-page {
            width: 19cm;
            min-height: 27cm;
            border: 1px solid #000;
            padding: 20px 20px 20px 20px;
            box-sizing: border-box;
            background-color: #fff;
            margin: 40px auto 20px auto;
            direction: rtl;
            unicode-bidi: embed;
        }


        .header {
            text-align: right;
            position: relative;
            margin-bottom: 45px;
            height: 140px;
        }

        .photo-box {
            width: 100px;
            height: 120px;
            border: 1px solid #000;
            text-align: center;
            line-height: 120px;
            position: absolute;
            top:95px;
            left: 0;
            font-size: 12px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
        }

        td {
            vertical-align: top;
            padding: 6px;
            font-size: 14px;
        }

        .line {
            border-bottom: 1px dotted #000;
            display: inline-block;
            width: 200px;
            min-height: 1em;
        }

        .section-title {
            text-align: right;
            font-weight: bold;
            width: 132px;
            margin: auto;
        }

        @media print {
            .no-print {
                display: none !important;
            }

            body {
                margin: 0;
            }
        }
    </style>
</head>

<body>
    <div class="no-print mt-4 text-center">
        <button onclick="downloadPDF()" class="btn btn-success">ğŸ“„ ØªØ­Ù…ÙŠÙ„ PDF</button>
    </div>
    <div class="a4-page" id="pdfContent">
        <div class="header">
            
            <div id="hideFromPDF" style="position: absolute; top: 65px; left: 0; text-align: center; width: 100px;">
                <p style="color: red; font-weight: bold; font-size: 10px; margin: 0;">ØªØ£ÙƒØ¯ Ù…Ù† Ø±ÙØ¹ ØµÙˆØ±Ø© Ø­Ø¯ÙŠØ«Ø©</p>
            </div>

            <div class="photo-box" id="studentPhoto">Ø¶Ø¹ Ø§Ù„ØµÙˆØ±Ø© Ù‡Ù†Ø§</div>

            <div class="d-flex justify-content-between align-items-center border-bottom pb-3">
                <h5><strong>Ø¬Ø§Ù…Ø¹Ø© Test</strong></h5>
                <h5><strong>Test university</strong></h5>
            </div>

        </div>

        <div class="section-title">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨</div>
        <table>
            <tr>
                <td>Ø§Ù„Ø§Ø³Ù… ÙƒØ§Ù…Ù„Ø§Ù‹ &nbsp; <span class="line" id="fullName"></span></td>
                <td>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ &nbsp;<span class="line" id="birthDate"></span></td>
            </tr>
            <tr>
                <td>Ø§Ù„Ø¬Ù†Ø³ÙŠØ© &nbsp; <span class="line" id="nationality"></span></td>
                <td>Ù…Ø­Ù„ Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ &nbsp; <span class="line" id="birthPlace"></span></td>
            </tr>
            <tr>
                <td>Ø§Ù„Ø¯ÙŠØ§Ù†Ø© &nbsp; <span class="line" id="religion"></span></td>
                <td>Ø§Ù„ÙƒÙ„ÙŠØ© Ø§Ù„Ù…ØªÙ‚Ø¯Ù… Ù„Ù‡Ø§ &nbsp; <span class="line" id="faculty"></span></td>
            </tr>
            <tr>
                <td>Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ &nbsp; <span class="line" id="phoneNumber"></span></td>
                <td>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø³ÙƒÙ† &nbsp; <span class="line" id="address"></span></td>
            </tr>
            <tr>
                <td>Ø§Ù„ØªÙ„ÙŠÙÙˆÙ† Ø§Ù„Ø£Ø±Ø¶ÙŠ &nbsp; <span class="line" id="landline"></span></td>
                <td>Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø© &nbsp; <span class="line" id="schoolName"></span></td>
            </tr>
            <tr>
                <td>Ø³Ù†Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„ÙŠÙ‡Ø§ &nbsp; <span class="line" id="gradYear"></span></td>
                <td>Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ© &nbsp; <span class="line" id="percent"></span></td>
            </tr>
            <tr>
                <td colspan="2"> Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ &nbsp; <span class="line" id="totalScore"></span></td>
            </tr>
        </table>

        <div class="section-title">Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</div>
        <table>
            <tr>
                <td>Ø§Ù„Ø§Ø³Ù… ÙƒØ§Ù…Ù„Ø§Ù‹ &nbsp;<span class="line" id="guardianName"></span></td>
                <td>Ù†ÙˆØ¹ Ø§Ù„Ù‚Ø±Ø§Ø¨Ø© &nbsp; <span class="line" id="guardianRelation"></span></td>
            </tr>
            <tr>
                <td>Ø§Ù„Ù…Ù‡Ù†Ø© &nbsp; <span class="line" id="guardianJob"></span></td>
                <td>Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ &nbsp;<span class="line" id="guardianPhone"></span></td>
            </tr>
            <tr>
                <td colspan="2"> ØªÙ„ÙŠÙÙˆÙ† Ø§Ù„Ø¹Ù…Ù„ &nbsp;<span class="line" id="guardianWorkPhone"></span></td>
            </tr>
        </table>

        <div class="section-title">Ø§Ø³ØªØ¨ÙŠØ§Ù†</div>
        <table>
            <tr>
                <td colspan="2">ÙƒÙŠÙ ØªØ¹Ø±ÙØª Ø¹Ù„Ù‰ Ø¬Ø§Ù…Ø¹Ø© TestØŸ</td>
            </tr>
            <tbody id="referralOptionsTable"></tbody>
            <tr>
                <td colspan="2">Ù…ØµØ§Ø¯Ø± Ø£Ø®Ø±Ù‰ <span class="line" id="referralSource"></span></td>
            </tr>
        </table>

        <table>
            <tr>
                <td>Ù…Ù…Ø§Ø±Ø³Ø© Ø£Ù†Ø´Ø·Ø© Ø±ÙŠØ§Ø¶ÙŠØ© Ø£Ùˆ Ù‡ÙˆØ§ÙŠØ§Øª <span class="line" id="activities"></span></td>
                <td>ØªØ­Ù‚ÙŠÙ‚ Ø¨Ø·ÙˆÙ„Ø§Øª Ù…Ø­Ù„ÙŠØ© Ø£Ùˆ Ø¯ÙˆÙ„ÙŠØ© <span class="line" id="awards"></span></td>
            </tr>
        </table>

        <div class="section-title border-bottom" style="padding-bottom: 1rem; width: 100%; text-align: center;">Ø¶Ø±ÙˆØ±Ø© Ù…Ù„Ø¡  ÙƒÙ„  Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
        <table>
            <tr>
                <td class="text-center w-100 fw-bold fs-6">ØªÙˆÙ‚ÙŠØ¹ Ù„Ø¬Ù†Ø© Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©</td>

            </tr>
            <tr>
                <td>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„Ø© <span class="line"></span></td>
            </tr>
        </table>
    </div>
    <script src="assets/static/js/DefaultSettingsBlock.js"></script>



    <script>
        function renderReferralOptions(selectedSources) {
            const allOptions = [
                "Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ ÙˆØ§Ù„Ø£Ù‚Ø§Ø±Ø¨",
                "Ù„Ø§ÙØªØ§Øª Ø§Ù„Ø·Ø±ÙŠÙ‚",
                "Facebook",
                "Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ù†Ø§Ø¯Ù‰ Ø³Ø¨ÙˆØ±ØªÙ†Ø¬ Ø§Ù„Ø±ÙŠØ§Ø¶Ù‰",
                "ØªÙˆØ²ÙŠØ¹ Ù„Ù…Ø·Ø¨ÙˆØ¹Ø§Øª Ø§Ù„Ø¬Ø§Ù…Ø¹Ù‡ (ÙÙ„Ø§ÙŠØ±/ Ø¨Ø±ÙˆØ´ÙˆØ±)",
                "Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†Ù‰ Ù„Ù„Ø¬Ø§Ù…Ø¹Ù‡",
                "Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ‡ Ù„Ù„Ø­Ø±Ù… Ø§Ù„Ø¬Ø§Ù…Ø¹Ù‰"
            ];
            const tableBody = document.getElementById("referralOptionsTable");
            tableBody.innerHTML = "";

            for (let i = 0; i < allOptions.length; i += 2) {
                const row = document.createElement("tr");
                for (let j = 0; j < 2; j++) {
                    const option = allOptions[i + j];
                    if (!option) break;
                    const checked = selectedSources.includes(option) ? "â˜‘" : "â˜";
                    const cell = document.createElement("td");
                    cell.textContent = `${option} ${checked}`;
                    row.appendChild(cell);
                }
                tableBody.appendChild(row);
            }
        }

        document.addEventListener("DOMContentLoaded", async () => {
            const universityId = sessionStorage.getItem("university_id");
            const imageBox = document.getElementById("studentPhoto");

            if (!universityId) return;

            try {
                const [meRes, reviewRes] = await Promise.all([
                    fetch("https://localhost:7286/api/StudentsView/me", { credentials: "include" }),
                    fetch(`https://localhost:7286/api/StudentsData/info/${universityId}`, { credentials: "include" })
                ]);

                if (!meRes.ok || !reviewRes.ok) throw new Error("Failed to fetch student data");

                const meData = await meRes.json();
                const reviewData = await reviewRes.json();

                const fill = (id, value) => {
                    const el = document.getElementById(id);
                    if (!el) return console.warn(`Missing element: ${id}`);
                    el.textContent = value ?? '';
                };

                fill("fullName", meData.fullName);
                fill("birthDate", meData.birthDate?.split("T")[0]);
                fill("birthPlace", meData.birthCountry);
                fill("nationality", meData.nationality);
                fill("religion", meData.religion);
                fill("faculty", meData.college || meData.degree);
                fill("address", meData.address);
                fill("phoneNumber", meData.phone);
                fill("landline", meData.landline);
                fill("schoolName", meData.school);
                fill("gradYear", meData.dateOfDegree?.split("T")[0]);
                fill("percent", meData.percentage);
                fill("totalScore", meData.totalMarks);
                fill("guardianName", meData.parentName);
                fill("guardianRelation", meData.relationship);
                fill("guardianJob", meData.proffesion);
                fill("guardianPhone", meData.parentPhoneNumber);
                fill("guardianWorkPhone", meData.workPhoneNumber);
                renderReferralOptions((reviewData.referralSource ?? "").split(","));
                fill("referralSource", reviewData.otherReferralSource);
                fill("activities", reviewData.activities);
                fill("awards", reviewData.awards);

                if (reviewData.imageAttach) {
                    imageBox.innerHTML = `<img src="https://localhost:7286/${reviewData.imageAttach}" style="width: 100%; height: 100%; object-fit: cover;" />`;
                }
            } catch (err) {
                console.error("Error fetching student data:", err);
            }
        });

        async function downloadPDF() {
            const btns = document.querySelector('.no-print');
            const redText = document.getElementById('hideFromPDF');

            btns.style.display = 'none';
            redText.style.display = 'none';

            const element = document.getElementById("pdfContent");
            const opt = {
                margin: 0,
                filename: 'student-data.pdf',
                image: { type: 'jpeg', quality: 1 },
                html2canvas: {
                    scale: 2,
                    scrollY: 0,
                    scrollX: 0,
                    useCORS: true,
                    letterRendering: true
                },
                jsPDF: { unit: 'cm', format: 'a4', orientation: 'portrait' }
            };

            await html2pdf().set(opt).from(element).save();
            btns.style.display = 'block';
            redText.style.display = 'block';
        }
    </script>
</body>

</html>